services:
  # --- Backend ---
  dspace:
    # Використовуємо офіційний образ або свій тег
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace:${DSPACE_REST_VER:-dspace-9_x}"
    container_name: dspace
    environment:
      JAVA_OPTS: "${DSPACE_JAVA_OPTS:--Xmx2000m}"
      # Backend має знати свої ПУБЛІЧНІ адреси (через які користувач заходить)
      dspace__P__server__P__url: "${DSPACE_REST_BASEURL}"
      dspace__P__ui__P__url: "${DSPACE_UI_BASEURL}"
    # Backend не публікує порти назовні в prod (доступ тільки через внутрішню мережу)
    expose:
      - "8080"
    networks:
      - dspacenet
    restart: unless-stopped

  # --- Database ---
  dspacedb:
    # Configured in base docker-compose.yml, here mostly for orchestration
    expose:
      - "5432"
    networks:
      - dspacenet
    restart: unless-stopped

  # --- Solr ---
  dspacesolr:
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace-solr:${DSPACE_SOLR_VER:-dspace-9_x}"
    container_name: dspacesolr
    expose:
      - "8983"
    networks:
      - dspacenet
    restart: unless-stopped

  # --- Frontend (Angular) ---
  dspace-angular:
    container_name: dspace-angular
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace-angular:${DSPACE_UI_VER:-dspace-9_x-dist}"
    depends_on:
      dspace:
        condition: service_healthy
    networks:
      - dspacenet
    
    # ВАЖЛИВО: Оскільки Nginx працює в режимі "service:dspace-angular",
    # порти для Nginx публікуємо ТУТ (на батьківському контейнері).
    # Host Port (8081) -> Container Port (80, де слухає Nginx)
    ports:
      - "${NGINX_HTTP_PORT:-8081}:80"
    
    volumes:
      - ./ui-config/config.yml:/app/config/config.yml:ro
    
    environment:
      # SSR всередині контейнера звертається до backend прямо по імені сервісу
      DSPACE_REST_SSRBASEURL: "${DSPACE_REST_SSRBASEURL:-http://dspace:8080/server}"
      # Оптимізація логів
      CI: "true"
      FORCE_COLOR: "0"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Healthcheck перевіряє сам Angular на його порту
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8081/ >/dev/null 2>&1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s

  # --- Nginx (Reverse Proxy) ---
  nginx:
    image: nginx:1.27-alpine
    container_name: dspace-nginx
    depends_on:
      dspace-angular:
        condition: service_healthy
    
    # Sidecar pattern: Nginx ділить мережевий стек з Angular
    network_mode: "service:dspace-angular"
    
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    
    # Healthcheck перевіряє Nginx на порту 80 (всередині namespace)
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:80/ >/dev/null 2>&1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

networks:
  dspacenet:
    name: dspacenet # Явне ім'я, щоб уникнути дублікатів
    driver: bridge
    ipam:
        config:
        - subnet: ${DSPACENET_SUBNET:-172.23.0.0/16}