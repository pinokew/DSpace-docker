services:
  # PROD: Nginx — єдина точка входу
  nginx:
    image: nginx:1.27-alpine
    container_name: dspace-nginx
    depends_on:
      dspace:
        condition: service_healthy
      dspace-angular:
        condition: service_healthy
    ports:
      - "${NGINX_HTTP_PORT:-8081}:80"
      # HTTPS пізніше
      # - "${NGINX_HTTPS_PORT:-8443}:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # - ./nginx/certs:/etc/nginx/certs:ro
    networks:
      - dspacenet
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/ >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s

  # PROD: backend — pull image, без build, без портів назовні
  dspace:
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace:${DSPACE_REST_VER:-dspace-9_x}"
    environment:
      # override з Dockerfile (за потреби)
      JAVA_OPTS: "${DSPACE_JAVA_OPTS:--Xmx2000m}"

      # важливо для редіректів/логіну
      dspace__P__server__P__url: "${DSPACE_REST_BASEURL}"
      dspace__P__ui__P__url: "${DSPACE_UI_BASEURL}"

    ports: []        # прибираємо публікацію 8080/8000 назовні
    expose:
      - "8080"
      - "8000"
    stdin_open: false
    tty: false

  # PROD: DB — без портів назовні
  dspacedb:
    ports: []
    expose:
      - "5432"
    stdin_open: false
    tty: false

  # PROD: Solr — pull image, без build, без портів назовні
  dspacesolr:
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace-solr:${DSPACE_SOLR_VER:-dspace-9_x}"
    ports: []
    expose:
      - "8983"
    stdin_open: false
    tty: false

  # PROD: UI — pull image, без ng serve, без портів назовні (лише через nginx)
  dspace-angular:
    container_name: dspace-angular
    depends_on:
      dspace:
        condition: service_healthy
    networks:
      - dspacenet

    # Для “продового” UI частіше використовують *-dist теги (зазвичай це зібраний фронт)
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace-angular:${DSPACE_UI_VER:-dspace-9_x-dist}"

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

    ports: []
    expose:
      - "4000"

    volumes:
      - ./ui-config/config.yml:/app/config/config.yml:ro

    environment:
      # UI публічна адреса — це Nginx (PUBLIC_*)
      DSPACE_UI_SSL: "${PUBLIC_SSL:-false}"
      DSPACE_UI_HOST: "${PUBLIC_HOST}"
      DSPACE_UI_PORT: "${PUBLIC_PORT}"
      DSPACE_UI_NAMESPACE: "/"

      # REST для браузера — теж через Nginx на цьому ж host:port
      DSPACE_REST_SSL: "${PUBLIC_SSL:-false}"
      DSPACE_REST_HOST: "${PUBLIC_HOST}"
      DSPACE_REST_PORT: "${PUBLIC_PORT}"
      DSPACE_REST_NAMESPACE: "/server"

      # REST для SSR всередині контейнера (docker DNS)
      DSPACE_REST_SSRBASEURL: "http://dspace:8080/server"

      CI: "${CI:-true}"
      FORCE_COLOR: "${FORCE_COLOR:-0}"

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:4000/ >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 40
      start_period: 90s
