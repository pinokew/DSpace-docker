services:
  # PROD: Nginx — єдина точка входу
  nginx:
    image: nginx:1.27-alpine
    container_name: dspace-nginx
    depends_on:
      dspace:
        condition: service_healthy
      dspace-angular:
        condition: service_healthy
    ports:
      - "${NGINX_HTTP_PORT:-8081}:80"
      # HTTPS додамо пізніше (або Cloudflare в кінці)
      # - "${NGINX_HTTPS_PORT:-8443}:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # - ./nginx/certs:/etc/nginx/certs:ro
    networks:
      - dspacenet
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/ >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s

  # PROD: backend — НЕ latest-test, без build, без debug порту назовні
  dspace:
    environment:
      # перевизначаємо JAVA_OPTS з Dockerfile (якщо треба)
      JAVA_OPTS: "${DSPACE_JAVA_OPTS:--Xmx2000m}"

      # важливо для редіректів/логіну
      dspace__P__server__P__url: "${DSPACE_REST_BASEURL}"
      dspace__P__ui__P__url: "${DSPACE_UI_BASEURL}"

    # у проді краще тягнути готовий образ (легше оновлювати)
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace:${DSPACE_REST_VER:-latest}"

    # В PROD не публікуємо REST/DEBUG назовні (лише nginx)
    ports: []
    stdin_open: false
    tty: false

  # PROD: DB — не публікуємо назовні
  dspacedb:
    ports: []
    stdin_open: false
    tty: false

  # PROD: Solr — не публікуємо назовні
  dspacesolr:
    ports: []
    stdin_open: false
    tty: false

  # PROD: UI — НЕ ng serve, без публікації 4000 назовні (тільки nginx)
  dspace-angular:
    container_name: dspace-angular
    depends_on:
      dspace:
        condition: service_healthy
    networks:
      - dspacenet

    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace-angular:${DSPACE_UI_VER:-latest}"

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

    # У PROD НЕ повинно бути command: npm run serve ...
    # command: []  # не треба

    # У PROD не публікуємо 4000/9876 назовні
    ports: []

    volumes:
      - ./ui-config/config.yml:/app/config/config.yml:ro

    environment:
      # UI “публічна” адреса — це Nginx (PUBLIC_*)
      DSPACE_UI_SSL: "${PUBLIC_SSL:-false}"
      DSPACE_UI_HOST: "${PUBLIC_HOST}"
      DSPACE_UI_PORT: "${PUBLIC_PORT}"
      DSPACE_UI_NAMESPACE: "/"

      # REST для браузера — теж через Nginx на цьому ж host:port
      DSPACE_REST_SSL: "${PUBLIC_SSL:-false}"
      DSPACE_REST_HOST: "${PUBLIC_HOST}"
      DSPACE_REST_PORT: "${PUBLIC_PORT}"
      DSPACE_REST_NAMESPACE: "/server"

      # REST для SSR всередині контейнера (docker DNS)
      DSPACE_REST_SSRBASEURL: "http://dspace:8080/server"

      CI: "${CI:-true}"
      FORCE_COLOR: "${FORCE_COLOR:-0}"

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:4000/ 2>/dev/null | grep -q '<ds-app'"]
      interval: 15s
      timeout: 5s
      retries: 40
      start_period: 90s
