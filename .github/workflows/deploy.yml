name: DSpace CI/CD Pipeline

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–∏ –ø—É—à—ñ –≤ –≥—ñ–ª–∫—É main –∞–±–æ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–µ–≥—ñ–≤ (—Ä–µ–ª—ñ–∑—ñ–≤)
on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

jobs:
  # ==========================================
  # 7.1 CI: Continuous Integration (–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏)
  # ==========================================
  ci-checks:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêö Run Shellcheck (Script Validation)
        run: shellcheck scripts/*.sh -e SC1090,SC1091,SC2034,SC2046,SC2086,SC2155

      - name: üê≥ YAML Validation (Docker Compose Config)
        run: |
          # –°—Ç–≤–æ—Ä—é—î–º–æ dummy .env —â–æ–± docker-compose –Ω–µ —Å–≤–∞—Ä–∏–≤—Å—è –Ω–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
          cp example.env .env
          docker compose config -q
          echo "‚úÖ docker-compose.yml is valid."

      - name: üîë Env Validation (Dry-Run)
        run: |
          chmod +x scripts/verify-env.sh
          ./scripts/verify-env.sh --ci-mock

      - name: ‚öôÔ∏è Config Patching Dry-Run
        run: |
          # –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–µ–π–∫–æ–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –¥–ª—è –∫–æ–Ω—Ñ—ñ–≥—ñ–≤
          mkdir -p dspace/config
          touch dspace/config/local.cfg
          # –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–∫—Ä–∏–ø—Ç –ø–∞—Ç—á–∏–Ω–≥—É. –Ø–∫—â–æ –≤—ñ–Ω –º—ñ—Å—Ç–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏ - CI –≤–ø–∞–¥–µ.
          chmod +x scripts/patch-local.cfg.sh
          ./scripts/patch-local.cfg.sh
          echo "‚úÖ Patching script executed without errors."

      - name: üõ°Ô∏è Trivy Vulnerability Scanner (Compose)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0' # –ó–º—ñ–Ω–∏ –Ω–∞ '1' —è–∫—â–æ —Ö–æ—á–µ—à, —â–æ–± CI –ø–∞–¥–∞–≤ —á–µ—Ä–µ–∑ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ

  # ==========================================
  # 7.2 CD: Continuous Deployment (–î–µ–ø–ª–æ–π)
  # ==========================================
  cd-deploy:
    needs: ci-checks # –ß–µ–∫–∞—î —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è CI
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–µ–ø–ª–æ–π –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —Ü–µ push –≤ main (–Ω–µ PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ GitHub runner –¥–æ —Ç–≤–æ—î—ó –º–µ—Ä–µ–∂—ñ Tailscale
      - name: üñß Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: üöÄ Deploy to Production Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }} #–¢—É—Ç —Ç–µ–ø–µ—Ä –º–∞—î –±—É—Ç–∏ Tailscale IP (100.x.x.x)
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true # –ó—É–ø–∏–Ω–∏—Ç–∏, —è–∫—â–æ —è–∫–∞—Å—å –∫–æ–º–∞–Ω–¥–∞ –≤–ø–∞–¥–µ
          script: |
            echo "Starting deployment..."
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –ø–∞–ø–∫—É –ø—Ä–æ—î–∫—Ç—É
            cd /home/${{ secrets.SERVER_USER }}/Dspace/DSpace-docker # –ó–º—ñ–Ω–∏ —à–ª—è—Ö, —è–∫—â–æ –≤—ñ–Ω —ñ–Ω—à–∏–π
            
            # 1. –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–¥ (–ë–ï–ó–ü–ï–ß–ù–ò–ô –ú–ï–¢–û–î –ó–ê–ú–Ü–°–¢–¨ PULL)
            # –ü—Ä–∏–º—É—Å–æ–≤–æ —Ä–æ–±–∏–º–æ —Å—Ç–∞–Ω —Å–µ—Ä–≤–µ—Ä–∞ —ñ–¥–µ–Ω—Ç–∏—á–Ω–∏–º –¥–æ –≥—ñ–ª–∫–∏ main –Ω–∞ GitHub.
            # –¶–µ —É–Ω–∏–∫–∞—î –ø–æ–º–∏–ª–æ–∫ "merge conflict", —è–∫—â–æ —Ñ–∞–π–ª–∏ –∑–º—ñ–Ω—é–≤–∞–ª–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
            git fetch origin main
            git reset --hard origin/main
            
            # 2. –ù–∞–¥–∞—î–º–æ –ø—Ä–∞–≤–∞ —Å–∫—Ä–∏–ø—Ç–∞–º (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ —è–∫—â–æ –≤–æ–Ω–∏ –∑–ª–µ—Ç—ñ–ª–∏)
            chmod +x scripts/*.sh
            
            # 3. –û–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–∞–∑–∏ —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î–º–æ
            docker compose pull
            docker compose up -d --remove-orphans
            
            # 4. –ó–∞–ø—É—Å–∫–∞—î–º–æ Smoke –¢–µ—Å—Ç–∏ –ø—Ä—è–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
            ./scripts/smoke-test.sh