name: DSpace CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

jobs:
  # ==========================================
  # 7.1 CI: Continuous Integration (ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸)
  # ==========================================
  ci-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: ðŸš Run Shellcheck (Script Validation)
        run: |
          # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ð’Ð¡Ð† bash-ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¸ Ñƒ scripts/ Ð²ÐºÐ»ÑŽÑ‡Ð½Ð¾ Ð· Ð¿Ñ–Ð´Ð¿Ð°Ð¿ÐºÐ°Ð¼Ð¸
          find scripts -type f -name "*.sh" -print0 \
            | xargs -0 shellcheck -e SC1090,SC1091,SC2034,SC2046,SC2086,SC2155

      - name: ðŸ³ YAML Validation (Docker Compose Config)
        run: |
          # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ dummy .env, Ñ‰Ð¾Ð± docker compose Ð½Ðµ ÑÐ²Ð°Ñ€Ð¸Ð²ÑÑ Ð½Ð° Ð²Ñ–Ð´ÑÑƒÑ‚Ð½Ñ– Ð·Ð¼Ñ–Ð½Ð½Ñ–
          cp example.env .env

          # Ð’Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÑƒ compose
          docker compose -f docker-compose.yml --env-file .env config -q

          # Ð”Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ð° Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ°: Ð¿Ñ–ÑÐ»Ñ Ñ€ÐµÐ½Ð´ÐµÑ€Ñƒ Ð½Ðµ Ð¿Ð¾Ð²Ð¸Ð½Ð½Ð¾ Ð»Ð¸ÑˆÐ°Ñ‚Ð¸ÑÑ ${...}
          docker compose -f docker-compose.yml --env-file .env config \
            | grep -n "\${" && { echo "âŒ Unresolved variables found in rendered compose"; exit 1; } || true

          echo "âœ… docker-compose.yml is valid."

      - name: ðŸ”‘ Env Validation (CI mock)
        run: |
          chmod +x scripts/verify-env.sh
          ./scripts/verify-env.sh --ci-mock

      - name: âš™ï¸ Config Patching Dry-Run
        run: |
          # Ð“Ð¾Ñ‚ÑƒÑ”Ð¼Ð¾ Ð¼Ñ–Ð½Ñ–Ð¼Ð°Ð»ÑŒÐ½Ñƒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ, ÑÐºÑ‰Ð¾ Ð¿Ð°Ñ‚Ñ‡ÐµÑ€ Ð¾Ñ‡Ñ–ÐºÑƒÑ” Ñ„Ð°Ð¹Ð»
          mkdir -p dspace/config
          touch dspace/config/local.cfg

          # Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ dummy .env (Ð· example.env), Ñ‰Ð¾Ð± Ð¿Ð°Ñ‚Ñ‡ÐµÑ€ Ð½Ðµ Ð¿Ð°Ð´Ð°Ð² Ð½Ð° Ð²Ñ–Ð´ÑÑƒÑ‚Ð½Ñ–Ñ… ÐºÐ»ÑŽÑ‡Ð°Ñ…
          cp example.env .env

          chmod +x scripts/patch-local.cfg.sh
          ./scripts/patch-local.cfg.sh

          echo "âœ… Patching script executed without errors."

      - name: ðŸ›¡ï¸ Trivy Config Scan (Critical gate)
        # pinned version (Ð½Ðµ master)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'

      - name: ðŸ›¡ï¸ Trivy Image Scan (Critical gate)
        run: |
          set -euo pipefail
          cp example.env .env

          docker compose -f docker-compose.yml --env-file .env config --images \
            | sort -u > /tmp/compose-images.txt

          echo "Images to scan:"
          cat /tmp/compose-images.txt

          TRIVY_IMAGE="aquasec/trivy:0.60.0"
          docker pull "$TRIVY_IMAGE"

          FAILED_IMAGES=()

          while IFS= read -r image; do
            [ -n "$image" ] || continue
            echo "::group::Trivy scan: $image"
            report_json="$(mktemp)"
            set +e
            docker run --rm \
              -v "$HOME/.cache/trivy:/root/.cache/" \
              -v "${PWD}:/work" \
              "$TRIVY_IMAGE" image \
              --quiet \
              --scanners vuln \
              --severity CRITICAL \
              --exit-code 1 \
              --ignore-unfixed \
              --ignorefile /work/.trivyignore \
              --format json \
              "$image" > "$report_json"
            RC=$?
            set -e
            echo "::endgroup::"

            if [ "$RC" -ne 0 ]; then
              FAILED_IMAGES+=("$image")
              echo "::error title=Trivy failed::Image '$image' has non-ignored CRITICAL findings."
              echo "Non-ignored CVEs for $image:"
              grep -Eo 'CVE-[0-9]{4}-[0-9]+' "$report_json" | sort -u | sed 's/^/ - /' || true
            fi

            rm -f "$report_json"
          done < /tmp/compose-images.txt

          if [ "${#FAILED_IMAGES[@]}" -gt 0 ]; then
            echo "âŒ Trivy failed for image(s):"
            printf ' - %s\n' "${FAILED_IMAGES[@]}"
            exit 1
          fi

          echo "âœ… Trivy image scan passed for all images."

  # ==========================================
  # 7.2 CD: Continuous Deployment (Ð”ÐµÐ¿Ð»Ð¾Ð¹)
  # ==========================================
  cd-deploy:
    needs: ci-checks
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð´Ð»Ñ push (Ð½Ðµ PR): Ð°Ð±Ð¾ main, Ð°Ð±Ð¾ Ñ‚ÐµÐ³ Ñ€ÐµÐ»Ñ–Ð·Ñƒ v*.*.*
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: dspace-prod-deploy
      cancel-in-progress: false
    env:
      DEPLOY_FULL_REF: ${{ github.ref }}
      DEPLOY_REF: ${{ github.ref_name }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ–§ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: ðŸš€ Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          # ÐŸÐµÑ€ÐµÐ´Ð°Ñ”Ð¼Ð¾ ref Ñƒ Ð²Ñ–Ð´Ð´Ð°Ð»ÐµÐ½Ð¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚
          envs: DEPLOY_FULL_REF,DEPLOY_REF
          script: |
            set -euo pipefail

            echo "Starting deployment..."

            PROJECT_DIR="${HOME}/Dspace/DSpace-docker"
            cd "$PROJECT_DIR"

            # 0) SSOT .env must exist
            if [ ! -f .env ]; then
              echo "âŒ ERROR: .env not found in $PROJECT_DIR. SSOT is missing."
              exit 1
            fi

            # 1) Safe update code (no git pull)
            git fetch --prune --tags origin

            # 1.1) Deploy tag or main (avoid commands that return 1 in conditions)
            case "${DEPLOY_FULL_REF}" in
              refs/tags/*)
                echo "Deploying tag: ${DEPLOY_REF}"
                git checkout -f "${DEPLOY_REF}"
                ;;
              *)
                echo "Deploying branch: main"
                git checkout -f main
                git reset --hard origin/main
                ;;
            esac

            # 2) Script permissions
            chmod +x scripts/*.sh || true

            # 3) Patch configs from SSOT (.env)
            chmod +x scripts/patch-local.cfg.sh
            ./scripts/patch-local.cfg.sh

            # 4) Pull + up
            docker compose pull
            docker compose up -d --remove-orphans

            # 5) Smoke tests
            chmod +x scripts/smoke-test.sh
            ./scripts/smoke-test.sh || {
              echo "---- docker compose ps ----"
              docker compose ps || true

              echo "---- dspace logs ----"
              docker logs --tail=120 dspace || true

              echo "---- traefik logs ----"
              docker logs --tail=120 dspace-traefik || true

              echo "---- solr logs ----"
              docker logs --tail=120 dspacesolr || true

              exit 1
            }

            echo "âœ… DEPLOY OK"

            
