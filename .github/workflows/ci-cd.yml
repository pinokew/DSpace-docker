name: DSpace CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

jobs:
  # ==========================================
  # 7.1 CI: Continuous Integration (–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏)
  # ==========================================
  ci-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: üêö Run Shellcheck (Script Validation)
        run: |
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –í–°–Ü bash-—Å–∫—Ä–∏–ø—Ç–∏ —É scripts/ –≤–∫–ª—é—á–Ω–æ –∑ –ø—ñ–¥–ø–∞–ø–∫–∞–º–∏
          find scripts -type f -name "*.sh" -print0 \
            | xargs -0 shellcheck -e SC1090,SC1091,SC2034,SC2046,SC2086,SC2155

      - name: üê≥ YAML Validation (Docker Compose Config)
        run: |
          # –°—Ç–≤–æ—Ä—é—î–º–æ dummy .env, —â–æ–± docker compose –Ω–µ —Å–≤–∞—Ä–∏–≤—Å—è –Ω–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
          cp example.env .env

          # –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É compose
          docker compose -f docker-compose.yml --env-file .env config -q

          # –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä—É –Ω–µ –ø–æ–≤–∏–Ω–Ω–æ –ª–∏—à–∞—Ç–∏—Å—è ${...}
          docker compose -f docker-compose.yml --env-file .env config \
            | grep -n "\${" && { echo "‚ùå Unresolved variables found in rendered compose"; exit 1; } || true

          echo "‚úÖ docker-compose.yml is valid."

      - name: üîë Env Validation (CI mock)
        run: |
          chmod +x scripts/verify-env.sh
          ./scripts/verify-env.sh --ci-mock

      - name: ‚öôÔ∏è Config Patching Dry-Run
        run: |
          # –ì–æ—Ç—É—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —è–∫—â–æ –ø–∞—Ç—á–µ—Ä –æ—á—ñ–∫—É—î —Ñ–∞–π–ª
          mkdir -p dspace/config
          touch dspace/config/local.cfg

          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ dummy .env (–∑ example.env), —â–æ–± –ø–∞—Ç—á–µ—Ä –Ω–µ –ø–∞–¥–∞–≤ –Ω–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö –∫–ª—é—á–∞—Ö
          cp example.env .env

          chmod +x scripts/patch-local.cfg.sh
          ./scripts/patch-local.cfg.sh

          echo "‚úÖ Patching script executed without errors."

      - name: üõ°Ô∏è Trivy Vulnerability Scanner (Compose)
        # pinned version (–Ω–µ master)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0' # –ü–æ—Å—Ç–∞–≤ '1', —è–∫—â–æ —Ö–æ—á–µ—à, —â–æ–± CI –ø–∞–¥–∞–≤ —á–µ—Ä–µ–∑ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ

  # ==========================================
  # 7.2 CD: Continuous Deployment (–î–µ–ø–ª–æ–π)
  # ==========================================
  cd-deploy:
    needs: ci-checks
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–µ–ø–ª–æ–π –¢–Ü–õ–¨–ö–ò –¥–ª—è push (–Ω–µ PR): –∞–±–æ main, –∞–±–æ —Ç–µ–≥ —Ä–µ–ª—ñ–∑—É v*.*.*
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: dspace-prod-deploy
      cancel-in-progress: false
    env:
      DEPLOY_FULL_REF: ${{ github.ref }}
      DEPLOY_REF: ${{ github.ref_name }}
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üñß Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: üöÄ Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          # –ü–µ—Ä–µ–¥–∞—î–º–æ ref —É –≤—ñ–¥–¥–∞–ª–µ–Ω–∏–π —Å–∫—Ä–∏–ø—Ç
          envs: DEPLOY_FULL_REF,DEPLOY_REF
          script: |
            set -euo pipefail

            echo "Starting deployment..."

            PROJECT_DIR="${HOME}/Dspace/DSpace-docker"
            cd "$PROJECT_DIR"

            # 0) SSOT .env must exist
            if [ ! -f .env ]; then
              echo "‚ùå ERROR: .env not found in $PROJECT_DIR. SSOT is missing."
              exit 1
            fi

            # 1) Safe update code (no git pull)
            git fetch --prune --tags origin

            # 1.1) Deploy tag or main (avoid commands that return 1 in conditions)
            case "${DEPLOY_FULL_REF}" in
              refs/tags/*)
                echo "Deploying tag: ${DEPLOY_REF}"
                git checkout -f "${DEPLOY_REF}"
                ;;
              *)
                echo "Deploying branch: main"
                git checkout -f main
                git reset --hard origin/main
                ;;
            esac

            # 2) Script permissions
            chmod +x scripts/*.sh || true

            # 3) Patch configs from SSOT (.env)
            chmod +x scripts/patch-local.cfg.sh
            ./scripts/patch-local.cfg.sh

            # 4) Pull + up
            docker compose pull
            docker compose up -d --remove-orphans

            # 5) Smoke tests
            chmod +x scripts/smoke-test.sh
            ./scripts/smoke-test.sh || {
              echo "---- docker compose ps ----"
              docker compose ps || true

              echo "---- dspace logs ----"
              docker logs --tail=120 dspace || true

              echo "---- traefik logs ----"
              docker logs --tail=120 dspace-traefik || true

              echo "---- solr logs ----"
              docker logs --tail=120 dspacesolr || true

              exit 1
            }

            echo "‚úÖ DEPLOY OK"

            
