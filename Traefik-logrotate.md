Налаштування системного Logrotate для Traefik

Проблема: Docker Log Rotation (який ми прописали в compose) обмежує лише логи, що йдуть у stdout (консоль). Файли access.log та traefik.log, які Traefik пише безпосередньо в примонтовану папку /srv/DSpace-volumes/logs/traefik/, будуть рости нескінченно.

Рішення: Використати вбудовану в Ubuntu утиліту logrotate.

Інструкція

Тобі потрібно створити один конфігураційний файл у системній папці Ubuntu. Скопіюй та виконай цей єдиний блок команд у терміналі:

sudo cat << 'EOF' | sudo tee /etc/logrotate.d/dspace-traefik
/srv/DSpace-volumes/logs/traefik/*.log {
    daily
    rotate 14
    missingok
    compress
    delaycompress
    notifempty
    copytruncate
}
EOF


Що роблять ці параметри:

daily: Ротація відбувається щодня.

rotate 14: Зберігати архіви за останні 14 днів (старіші видаляються).

compress: Стискати старі логи в .gz для економії місця.

delaycompress: Вчорашній лог ще не стискається (зручно для аналізу), стискаються старіші.

copytruncate: Магія для Docker. Замість видалення файлу і створення нового (що зламало б запис з контейнера), ця команда копіює дані в архів, а потім обрізає оригінальний файл до 0 байт. Контейнер навіть не помітить, що щось сталося, і продовжить писати.

Перевірка (Dry Run)

Щоб перевірити, чи система зрозуміла твій конфіг, і чи немає синтаксичних помилок, запусти:

sudo logrotate -d /etc/logrotate.d/dspace-traefik


(Прапорець -d означає "Dry Run" — воно покаже, що б воно зробило, але реально файли не обріже. Якщо помилок не вивело — все ідеально).