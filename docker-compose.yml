services:
  # ===================================================
  # DATABASE (PostgreSQL)
  # ===================================================
  dspacedb:
    container_name: dspacedb
    image: "docker.io/postgres:${POSTGRES_VERSION:-15}"
    restart: unless-stopped
    environment:
      TZ: ${TZ:-Europe/Kyiv}
      PGDATA: ${POSTGRES_PGDATA:-/pgdata}
      POSTGRES_DB: ${POSTGRES_DB:-dspace}
      POSTGRES_USER: ${POSTGRES_USER:-dspace}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dspace}
    networks:
      - dspacenet
    volumes:
      - ${VOL_POSTGRESQL_PATH:-./data/pgdata}:${POSTGRES_PGDATA:-/pgdata}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dspace} -d ${POSTGRES_DB:-dspace} -h 127.0.0.1 -p ${POSTGRES_INTERNAL_PORT:-5432}"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s

  # ===================================================
  # SEARCH ENGINE (Solr)
  # ===================================================
  dspacesolr:
    container_name: dspacesolr
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace-solr:${DSPACE_SOLR_VER:-dspace-9_x}"
    restart: unless-stopped
    environment:
      TZ: ${TZ:-Europe/Kyiv}
      SOLR_OPTS: "-Dsolr.config.lib.enabled=true"
    networks:
      - dspacenet
    working_dir: /var/solr/data
    volumes:
      - ${VOL_SOLR_PATH:-./data/solr}:/var/solr/data
    user: root
    # Ініціалізація ядер, якщо папка порожня
    entrypoint:
      - /bin/bash
      - -c
      - |
        set -e
        if [ ! -d "/var/solr/data/authority" ]; then
            echo "Initializing Solr cores..."
            init-var-solr
            precreate-core authority /opt/solr/server/solr/configsets/authority
            cp -r /opt/solr/server/solr/configsets/authority/* authority
            precreate-core oai /opt/solr/server/solr/configsets/oai
            cp -r /opt/solr/server/solr/configsets/oai/* oai
            precreate-core search /opt/solr/server/solr/configsets/search
            cp -r /opt/solr/server/solr/configsets/search/* search
            precreate-core statistics /opt/solr/server/solr/configsets/statistics
            cp -r /opt/solr/server/solr/configsets/statistics/* statistics
            precreate-core qaevent /opt/solr/server/solr/configsets/qaevent
            cp -r /opt/solr/server/solr/configsets/qaevent/* qaevent
            precreate-core suggestion /opt/solr/server/solr/configsets/suggestion
            cp -r /opt/solr/server/solr/configsets/suggestion/* suggestion
            chown -R solr:solr /var/solr
        else
            echo "Solr cores already initialized."
            chown -R solr:solr /var/solr
        fi
        runuser -u solr -- solr-foreground
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:${SOLR_INTERNAL_PORT:-8983}/solr/ >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 18
      start_period: 30s

  # ===================================================
  # BACKEND (REST API)
  # ===================================================
  dspace:
    container_name: dspace
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace:${DSPACE_REST_VER:-dspace-9_x}"
    restart: unless-stopped
    environment:
      TZ: ${TZ:-Europe/Kyiv}
      JAVA_OPTS: "${DSPACE_JAVA_OPTS:--Xmx2000m -Djava.security.egd=file:/dev/./urandom}"
      # Внутрішні налаштування
      dspace__P__dir: ${DSPACE_DIR:-/dspace}
      dspace__P__name: ${DSPACE_NAME:-KDV Library Repository}
      db__P__url: "jdbc:postgresql://dspacedb:${POSTGRES_INTERNAL_PORT:-5432}/${POSTGRES_DB:-dspace}"
      solr__P__server: "http://dspacesolr:${SOLR_INTERNAL_PORT:-8983}/solr"
      # Публічні URL (для користувача)
      dspace__P__server__P__url: ${DSPACE_REST_BASEURL:-http://localhost:8081/server}
      dspace__P__ui__P__url: ${DSPACE_UI_BASEURL:-http://localhost:8081}
      # CORS та Proxy
      proxies__P__trusted__P__ipranges: ${PROXIES_TRUSTED_IPRANGES:-0.0.0.0/0}
      rest__P__cors__P__allowed__D__origins: ${DSPACE_UI_BASEURL:-http://localhost:8081}
    depends_on:
      dspacedb:
        condition: service_healthy
      dspacesolr:
        condition: service_healthy
    networks:
      - dspacenet
    expose:
      - "8080" # Тільки для внутрішньої мережі, Nginx проксує сюди
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - ${VOL_ASSETSTORE_PATH:-./data/assetstore}:/dspace/assetstore
      - ${VOL_EXPORTS_PATH:-./data/exports}:/dspace/exports
      - ./dspace/config/local.cfg:/dspace/config/local.cfg
      - ./dspace/config/submission-forms.xml:/dspace/config/submission-forms.xml 
    entrypoint:
      - /bin/bash
      - -c
      - |
        set -e
        echo "Waiting for DB..."
        until (</dev/tcp/dspacedb/5432) >/dev/null 2>&1; do sleep 1; done
        echo "Running DB migrations..."
        /dspace/bin/dspace database migrate
        echo "Starting DSpace REST..."
        java $JAVA_OPTS -jar /dspace/webapps/server-boot.jar --dspace.dir=/dspace
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:${DSPACE_INTERNAL_PORT:-8080}${DSPACE_REST_NAMESPACE:-/server}/api/core/sites >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 60s

  # ===================================================
  # FRONTEND (Angular) + NGINX Sidecar
  # ===================================================
  dspace-angular:
    container_name: dspace-angular
    image: "${DOCKER_REGISTRY:-docker.io}/${DOCKER_OWNER:-dspace}/dspace-angular:${DSPACE_UI_VER:-dspace-9_x-dist}"
    restart: unless-stopped
    depends_on:
      dspace:
        condition: service_healthy
    networks:
      - dspacenet
    # Цей порт мапиться на HOST:8081, але трафік приймає Nginx (порт 80 всередині контейнера)
    ports:
      - "${NGINX_HTTP_PORT:-8081}:80"
    volumes:
      - ./ui-config/config.yml:/app/config/config.yml:ro
    environment:
      # Важливо: SSR всередині має ходити напряму до бекенду
      DSPACE_REST_SSRBASEURL: ${DSPACE_REST_SSRBASEURL:-http://dspace:8080/server}
      # Явно задаємо базові URL, щоб перекрити можливі помилки в config.yml
      DSPACE_UI_BASEURL: ${DSPACE_UI_BASEURL:-http://localhost:8081}
      DSPACE_REST_BASEURL: ${DSPACE_REST_BASEURL:-http://localhost:8081/server}
      DSPACE_UI_HOST: ${DSPACE_UI_HOST:-0.0.0.0}
      DSPACE_UI_PORT: ${DSPACE_UI_PORT:-8081}
      DSPACE_UI_SSL: ${DSPACE_UI_SSL:-false}
      # Логи
      CI: "true"
      FORCE_COLOR: "0"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:${DSPACE_UI_PORT:-8081}/ >/dev/null 2>&1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s

  # Nginx (Sidecar) - працює в мережевому просторі Angular контейнера
  nginx:
    image: nginx:1.27-alpine
    container_name: dspace-nginx
    restart: unless-stopped
    depends_on:
      dspace-angular:
        condition: service_healthy
    network_mode: "service:dspace-angular"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:80/ >/dev/null 2>&1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  ngrok:
    image: ngrok/ngrok:latest
    container_name: dspace-ngrok
    restart: unless-stopped
    command: http --domain=untaking-amusively-staci.ngrok-free.dev dspace-angular:80
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
    ports:
      - "4040:4040" # Веб-інтерфейс Ngrok для моніторингу запитів
    networks:
      - dspacenet
    depends_on:
      - nginx

  # Cloudflare Tunnel
  # tunnel:
  #   image: cloudflare/cloudflared:latest
  #   container_name: dspace-tunnel
  #   restart: unless-stopped
  #   command: tunnel --protocol http2 --loglevel debug run
  #   environment:
  #     - TUNNEL_TOKEN=${TUNNEL_TOKEN}
  #   networks:
  #     - dspacenet
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
    
networks:
  dspacenet:
    name: dspacenet
    driver: bridge
    ipam:
      config:
        - subnet: ${DSPACENET_SUBNET:-172.23.0.0/16}